/*
Ajout des contraintes internes au schéma EXP.

Il est suggéré d'exécuter ce fichier après l'exportation au titre de vérification.

@fixme 2019-06-02 [DC] Ce fichier est un duplicat du projet tiger-mapping-omnimed. Il faudrait créer un projet SQL commun pour éviter cette situation. 
*/

ALTER TABLE "EXP"."PATIENT"
  ADD CONSTRAINT "EXP_PATIENT_PK" PRIMARY KEY ("ID_PATIENT_EXT");

ALTER TABLE "EXP"."DOSSIER"
  ADD CONSTRAINT "EXP_DOSSIER_PK" PRIMARY KEY ("ID_PATIENT_EXT");
ALTER TABLE "EXP"."DOSSIER"
  ADD CONSTRAINT "EXP_DOSSIER_UK1" UNIQUE ("ID_PATIENT_UUID");

ALTER TABLE "EXP"."MEDECIN"
  ADD CONSTRAINT "EXP_MEDECIN_PK" PRIMARY KEY ("ID_MEDECIN_EXT");

ALTER TABLE "EXP"."MEDECIN_TRAITANT"
  ADD CONSTRAINT "EXP_MEDECIN_TRAITANT_PK"
    PRIMARY KEY ("ID_PATIENT_EXT", "ID_MEDECIN_EXT");

ALTER TABLE "EXP"."LABORATOIRE"
  ADD CONSTRAINT "EXP_LABORATOIRE_PK" PRIMARY KEY ("ID_LABORATOIRE_EXT");

ALTER TABLE "EXP"."MEDICAMENT"
  ADD CONSTRAINT "EXP_MEDICAMENT_PK" PRIMARY KEY ("ID_MEDICAMENT_EXT");
ALTER TABLE "EXP"."MEDICAMENT"
  ADD CONSTRAINT "EXP_MEDICAMENT_UK1" UNIQUE ("DIN_CODE");

ALTER TABLE "EXP"."CLASSE_MEDICAMENT"
  ADD CONSTRAINT "EXP_CLASSE_MEDICAMENT_PK" PRIMARY KEY ("DIN_CODE");

ALTER TABLE "EXP"."PRESCRIPTION"
  ADD CONSTRAINT "EXP_PRESCRIPTION_PK" PRIMARY KEY ("ID_PRESCRIPTION_EXT");

ALTER TABLE "EXP"."CONSULTATION"
  ADD CONSTRAINT "EXP_CONSULTATION_PK" PRIMARY KEY ("ID_CONSULTATION_EXT");

COMMIT;

/*
FIXME 2019-03-09 [LL] {"ID_PATIENT_EXT", "ID_MEDECIN_EXT", "DATE_CONS"} est-elle une clé ?
 * Sans "ID_CONSULTATION_EXT" on constate qu'un patient peut avoir plus d'un
   rendez-vous avec le même médecin au même moment.
*/
ALTER TABLE "EXP"."CONSULTATION"
  ADD CONSTRAINT "EXP_CONSULTATION_UK1"
    UNIQUE ("ID_PATIENT_EXT", "DATE_CONS");
ALTER TABLE "EXP"."CONSULTATION"
  DROP CONSTRAINT "EXP_CONSULTATION_UK1" ;

/*
FIXME 2019-03-09 [LL] {"ID_PATIENT_EXT", "DATE_PRELEVEMENT", "NOM_TEST"} est-elle une clé ?
 * En excluant ID_DEMANDE_LABO de "EXP_LABORATOIRE", on a fait cette hypothèse.
*/
ALTER TABLE "EXP"."LABORATOIRE"
  ADD CONSTRAINT "EXP_LABORATOIRE_UK1"
    UNIQUE ("ID_PATIENT_EXT", "DATE_PRELEVEMENT", "NOM_TEST");
ALTER TABLE "EXP"."LABORATOIRE"
  DROP CONSTRAINT "EXP_LABORATOIRE_UK1" ;

/*
FIXME 2019-03-09 [LL] {"ID_PATIENT_EXT", "ID_MEDECIN_EXT", "ID_MEDICAMENT_EXT", "DEBUT"} est-elle une clé ?
 * En excluant MEDICATION.MEDICATION_ID de "EXP_PRESCRIPTION", on a fait cette hypothèse.
*/
ALTER TABLE "EXP"."PRESCRIPTION"
  ADD CONSTRAINT "EXP_PRESCRIPTION_UK1"
    UNIQUE ("ID_PATIENT_EXT", "ID_MEDECIN_EXT", "ID_MEDICAMENT_EXT", "DEBUT");
ALTER TABLE "EXP"."PRESCRIPTION"
  DROP CONSTRAINT "EXP_PRESCRIPTION_UK1" ;

/*
FIXME 2019-03-09 [LL] {"ID_CONSULTATION_EXT", "ID_MEDICAMENT_EXT"} est-elle une clé ?
 * Cela ne doit-il pas être {"ID_CONSULTATION_EXT", "ID_MEDICAMENT_EXT", "MOMENT"}
 * puisque "MOMENT" n'a le plus souvent qu'une granularité d'un jour ?
 * les données au 2019-03-17 n'infirment pas cette hypothèse.
*/
ALTER TABLE "EXP"."MEDICATION_SP"
  ADD CONSTRAINT "EXP_MEDICATION_SP_PK"
    PRIMARY KEY ("ID_CONSULTATION_EXT", "ID_MEDICAMENT_EXT");
ALTER TABLE "EXP"."MEDICATION_SP"
  DROP CONSTRAINT "EXP_MEDICATION_SP_PK" ;

/* *-======================================================================-* */
